
/*
 * -------------------------------------------------------
 * Project: Ember Frozen
 * Version: 0.0.1
 *
 * Author:  Pierpaolo Follia
 * Site:     http://madchicken.it
 * Contact: pfollia@gmail.com
 *
 *
 * Copyright (c) 2013 Pierpaolo Follia
 * -------------------------------------------------------
 */

"use strict";!function(){var converters={},get=Ember.get,set=Ember.set,setupRelationship=function(model,name,options){if("string"==typeof options.destination){var dst=get(options.destination);if(!dst){var s=options.destination.split(".");s.length&&(dst=Ember.Namespace.byName(s[0]).get(s.slice(1).join(".")))}options.destination=dst}Ember.assert("You must provide a valid model class for field "+name,null!=options.destination&&void 0!=options.destination);var rel=relationships[options.relationshipType].create({type:options.relationshipType,options:options});set(model,"_relationships."+name,rel),get(model,"_backup")[name]=rel,set(model,"_data."+name,rel)},initField=function(model,name,options){if(Ember.assert("Field name must not be null",null!==name&&void 0!==name&&""!=name),get(model,"_backup").hasOwnProperty(name)===!1){options=options||{},options.isRelationship?setupRelationship(model,name,options):(get(model,"_backup")[name]=options.defaultValue,set(model,"_data."+name,options.defaultValue));var properties=get(model,"_properties");-1===properties.indexOf(name)&&properties.push(name)}},attr=function(type,options){return type=type||"string",options=options||{},function(key,value){initField(this,key,options);var converter=Frzn.getConverter(type),path="_data."+key;if(arguments.length>1){options.isRelationship&&(path="_data."+key+".content");var oldValue=this.get(path);value=converter.convert(value,options),this.set(path,value),oldValue!=value&&this._markDirty(key)}else value=this.get(path),options.isRelationship&&!options.embedded&&value.set("content",options.destination.find(this.get("_data."+key+".id")));return value}.property("_data").cacheable(!1).meta({type:type,options:options})},Frzn={version:"0.8.0",attr:attr,hasMany:function(destination,options){return options=options||{},options.embedded=void 0!==options.embedded?options.embedded:!0,Frzn.registerConverter("hasMany"+destination,ModelArrayConverter.extend({})),Frzn.attr("hasMany"+destination,Ember.merge(options,{isRelationship:!0,relationshipType:"hasMany",destination:destination}))},hasOne:function(destination,options){return options=options||{},options.embedded=void 0!==options.embedded?options.embedded:!0,Frzn.registerConverter("hasOne"+destination,ModelConverter.extend({})),Frzn.attr("hasOne"+destination,Ember.merge(options,{isRelationship:!0,relationshipType:"hasOne",destination:destination}))},belongsTo:function(destination,options){return options=options||{},options.embedded=void 0!==options.embedded?options.embedded:!1,Frzn.registerConverter("belongsTo"+destination,ModelConverter.extend({})),Frzn.attr("belongsTo"+destination,Ember.merge(options,{isRelationship:!0,relationshipType:"belongsTo",destination:destination}))},registerConverter:function(name,converter){converters[name]=converter.create()},getConverter:function(name){return converters[name]||SimpleConverter.create({})}},SimpleConverter=Ember.Object.extend({convert:function(value){return value?value.valueOf():value}}),ModelConverter=Ember.Object.extend({convert:function(value,options){return value instanceof options.destination?value:"object"==typeof value?options.destination.create(value):null}}),ModelArrayConverter=Ember.Object.extend({convert:function(value,options){if(value instanceof Array){for(var array=[],i=0;i<value.length;i++)array.push(options.destination.create(value[i]));return array}return null}});Frzn.registerConverter("string",SimpleConverter.extend({convert:function(value){return Ember.isEmpty(value)?value:new String(value).valueOf()}})),Frzn.registerConverter("boolean",SimpleConverter.extend({convert:function(value){return!!value}})),Frzn.registerConverter("object",SimpleConverter.extend({convert:function(value){return value}})),Frzn.registerConverter("number",SimpleConverter.extend({convert:function(value){if(null!==value&&void 0!==value){var num=new Number(value);return num.valueOf()}return value}})),Frzn.registerConverter("date",SimpleConverter.extend({convert:function(value){if(null!==value&&void 0!==value){if("string"==typeof value){var d=new Date(Date.parse(value));return isNaN(d.getTime())?null:d}return value instanceof Date?value:null}return value}}));var Relationship=Em.Mixin.create({getObjectClass:function(){return this.get("options.destination")}}),HasManyRelationship=Ember.ArrayProxy.extend(Relationship,{init:function(){this.set("content",Em.A([])),this._super()},create:function(data){var o=this.get("options.destination").create(data);return this.pushObject(o),o}}),HasOneRelationship=Ember.ObjectProxy.extend(Relationship,{}),BelongsToRelationship=Ember.ObjectProxy.extend(Relationship,{}),relationships={hasOne:HasOneRelationship,hasMany:HasManyRelationship,belongsTo:BelongsToRelationship};Frzn.Model=Ember.Object.extend(Ember.DeferredMixin,Ember.Evented,{isAjax:!1,isLoaded:!1,isSaved:!1,isDeleted:!1,url:null,errors:null,_backup:function(){return this.__backup||(this.__backup={}),this.__backup}.property(),_data:function(){return this.__data||(this.__data=Em.Object.create({})),this.__data}.property(),_dirtyAttributes:function(){return this.__dirtyAttributes||(this.__dirtyAttributes=[]),this.__dirtyAttributes}.property(),_properties:function(){return this.__properties||(this.__properties=Em.A([])),this.__properties}.property(),_relationships:function(){return this.__relationships||(this.__relationships=Em.Object.create({})),this.__relationships}.property(),_saveState:function(){for(var properties=this.get("_properties"),backup=this.get("_backup"),i=0;i<properties.length;i++)backup[properties[i]]=this.get("_data."+properties[i]);return this.set("_dirtyAttributes",[]),this},_discardChanges:function(){var backup=this.get("_backup");return this.setProperties(backup),this.set("_data",Ember.Object.create(backup)),this.set("_dirtyAttributes",[]),this},_markDirty:function(field){var dirtyAttributes=this.get("_dirtyAttributes");-1===dirtyAttributes.indexOf(field)&&dirtyAttributes.push(field)},init:function(){this._super(),this._saveState()},discard:function(){return this._discardChanges()},isDirty:function(attr){var dirtyAttributes=this.get("_dirtyAttributes");if(void 0!==attr)return!Ember.isEmpty(dirtyAttributes)&&-1!=dirtyAttributesindexOf(attr);var dirty=!1,relationships=this.get("_relationships");for(var relname in relationships)if(relationships.hasOwnProperty(relname)){var rel=relationships[relname];"hasOne"==rel.get("type")||"belongsTo"==rel.get("type")?dirty|=rel.get("content").isDirty():"hasMany"==rel.get("type")&&(dirty|=rel.get("content").reduce(function(previousValue,item){return previousValue|=item.isDirty()},!1))}return dirty||!Ember.isEmpty(dirtyAttributes)},commit:function(){return this._saveState()},toJSON:function(){return JSON.stringify(this.getProperties(this.get("_properties")))},load:function(data){return this.setProperties(data),this.commit(),this},save:function(){return this.constructor.adapter.createRecord(this.constructor,this)},update:function(){return this.constructor.adapter.updateRecord(this.constructor,this)},remove:function(){return this.constructor.adapter.deleteRecord(this.constructor,this)},reload:function(){return this.constructor.adapter.reloadRecord(this.constructor,this)}}),Frzn.Model.reopenClass({getName:function(){var name=this+"";return-1!=name.lastIndexOf(".")&&(name=name.substr(name.lastIndexOf(".")+1)),name.toLowerCase()},find:function(id){var record=this.create();return this.adapter.find(this,record,id)},findAll:function(){var records=Frzn.RecordArray.create({type:this});return this.adapter.findAll(this,records)},findQuery:function(params){var records=Frzn.RecordArray.create({type:this});return this.adapter.findQuery(this,records,params)},findIds:function(){var records=Frzn.RecordArray.create({type:this}),ids=Array.prototype.slice.apply(arguments);return this.adapter.findIds(this,records,ids)}}),window.Frzn=Frzn}(),!function(){var AbstractAdapter=Ember.Object.extend({extractMeta:null,_didLoad:function(data,record){record.load(data),record.set("isLoaded",!0),record.trigger("didLoad",record),record.resolve(record)},_didLoadMany:function(data,records){records.load(data),this.extractMeta&&"function"==typeof this.extractMeta&&this.extractMeta(data,records),records.resolve(records)},_didCreate:function(data,record){record.load(data),record.set("isSaved",!0),record.set("isLoaded",!0),record.trigger("didSave",record),record.resolve(record)},_didUpdate:function(data,record){record.load(data),record.set("isSaved",!0),record.set("isLoaded",!0),record.trigger("didSave",record),record.resolve(record)},_didDelete:function(data,record){record.set("isDeleted",!0),record.trigger("didDelete",record),record.resolve(record)},find:function(){Ember.assert("You must provide a valid find function for your adapter",!1)},findAll:function(){Ember.assert("You must provide a valid findAll function for your adapter",!1)},findQuery:function(){Ember.assert("You must provide a valid findQuery function for your adapter",!1)},findIds:function(){Ember.assert("You must provide a valid findIds function for your adapter",!1)},createRecord:function(){Ember.assert("You must provide a valid createRecord function for your adapter",!1)},updateRecord:function(){Ember.assert("You must provide a valid updateRecord function for your adapter",!1)},reloadRecord:function(){Ember.assert("You must provide a valid reloadRecord function for your adapter",!1)},deleteRecord:function(){Ember.assert("You must provide a valid delete function for your adapter",!1)},rootProperty:null,totalProperty:null,pageProperty:null}),RecordArray=Ember.ArrayProxy.extend(Ember.DeferredMixin,{init:function(){this._super(),this.set("meta",Em.Object.create({})),Ember.assert("You must specify a type for a record array",void 0!=this.type)},load:function(data){if(this.set("content",Em.A([])),data instanceof Array)for(var i=0;i<data.length;i++){var o=this.type.create(data[i]);o.set("isLoaded",!0),this.pushObject(o)}return this}}),InMemoryAdapter=AbstractAdapter.extend({store:null,find:function(modelClass,record,id){var name=modelClass.getName(),data=this.store[name].findBy("id",id);return data?this._didLoad(data,record):record.reject({errorCode:404,type:"error",message:"Object not found"}),record},findAll:function(modelClass,records){var name=modelClass.getName();if(this.store[name]){var data=this.store[name];this._didLoadMany(data,records)}else records.reject({errorCode:404,type:"error",message:"Object not found"});return records},findQuery:function(modelClass,records,params){var name=modelClass.getName();if(this.store[name]){var data=this.store[name];for(var prop in params)data=data.filterBy(prop,params[prop]);this._didLoadMany(data,records)}else records.reject({errorCode:404,type:"error",message:"Object not found"});return records},findIds:function(modelClass,records,ids){var name=modelClass.getName();if(this.store[name]){for(var data=Em.A([]),index=0;index<ids.length;index++){var rec=this.store[name].findBy("id",ids[index]);data.push(rec)}this._didLoadMany(data,records)}else records.reject({errorCode:404,type:"error",message:"Object not found"});return records},createRecord:function(modelClass,record){var name=modelClass.getName();return this.store[name]&&(record.set("id",this.store[name].length),this.store[name].push(record),this._didCreate(record.toJSON(),record)),record},updateRecord:function(){Ember.assert("You must provide a valid updateRecord function for your adapter",!1)},deleteRecord:function(){Ember.assert("You must provide a valid delete function for your adapter",!1)},rootProperty:null,totalProperty:null,pageProperty:null});InMemoryAdapter.reopenClass({createWithData:function(data){return InMemoryAdapter.create({store:data})}}),Frzn.AbstractAdapter=AbstractAdapter,Frzn.RecordArray=RecordArray,Frzn.InMemoryAdapter=InMemoryAdapter}(),!function(){var UrlMappingAdapter=Frzn.AbstractAdapter.extend({rootPath:"",urlMapping:null,init:function(){this._super(),Ember.assert("You must provide a valid url map table",null!==this.urlMapping&&void 0!==this.urlMapping)},setupAjax:function(action,modelClass,params){var d=this.urlMapping[action];if(d=d||{url:":resourceURI/",type:"GET"},d=Ember.copy(d,!0),d.url=d.url.replace(":resourceURI",modelClass.url||modelClass.getName()),params)for(var name in params)params.hasOwnProperty(name)&&(d.url=d.url.replace(":"+name,params[name]));return this.rootPath&&(d.url=this.rootPath+url),d},find:function(modelClass,record,id){var config=this.setupAjax("find",modelClass,{id:id});return $.ajax(Ember.merge(config,{beforeSend:function(){record.set("isAjax",!0)},complete:function(){record.set("isAjax",!1)},success:function(data){var obj=modelClass.rootProperty?data[modelClass.rootProperty]:data;this._didLoad(obj,record)},error:function(response,type,title){record.set("isLoaded",!1),record.reject(response,type,title)}})),record},findAll:function(modelClass,records){var config=this.setupAjax("findAll",modelClass);return $.ajax(Ember.merge(config,{success:function(data){var obj=modelClass.rootProperty?data[modelClass.rootProperty]:data;this._didLoadMany(obj,records)},error:function(response,type,title){records.reject(response,type,title)}})),records},findQuery:function(modelClass,records,params){var config=this.setupAjax("findQuery",modelClass,params);return $.ajax(Ember.merge(config,{data:params,success:function(data){var obj=modelClass.rootProperty?data[modelClass.rootProperty]:data;records.load(obj),records.resolve(records)},error:function(response,type,title){records.reject(response,type,title)}})),records},findIds:function(modelClass,records,ids){var config=this.setupAjax("findIds",modelClass,{ids:ids});return $.ajax(Ember.merge(config,{success:function(data){var obj=modelClass.rootProperty?data[modelClass.rootProperty]:data;records.load(obj),records.resolve(records)},error:function(response,type,title){records.reject(response,type,title)}})),records},createRecord:function(modelClass,record){var config=this.setupAjax("createRecord",modelClass);return $.ajax(Ember.merge(config,{success:function(data){var obj=modelClass.rootProperty?data[modelClass.rootProperty]:data;this._didCreate(obj,record)},error:function(response,type,title){record.reject(response,type,title)}})),record},updateRecord:function(modelClass,record){var config=this.setupAjax("updateRecord",modelClass);return $.ajax(Ember.merge(config,{success:function(data){modelClass.rootProperty?data[modelClass.rootProperty]:data,this._didUpdate(data,record)},error:function(response,type,title){record.discard(),record.reject(response,type,title)}})),record},deleteRecord:function(modelClass,record){var config=this.setupAjax("deleteRecord",modelClass);return $.ajax(Ember.merge(config,{success:function(data){var obj=modelClass.rootProperty?data[modelClass.rootProperty]:data;this._didDelete(obj,record)},error:function(response,type,title){record.reject(response,type,title)}})),record},reloadRecord:function(modelClass,record){var config=this.setupAjax("find",modelClass,{id:record.get("id")});return record.set("_deferred",Ember.RSVP.defer()),$.ajax(Ember.merge(config,{beforeSend:function(){record.set("isAjax",!0)},complete:function(){record.set("isAjax",!1)},success:function(data){var obj=modelClass.rootProperty?data[modelClass.rootProperty]:data;record.load(obj),record.set("isLoaded",!0),record.trigger("didLoad",record),record.resolve(record)},error:function(response,type,title){record.set("isLoaded",!1),record.reject(response,type,title)}})),record}});Frzn.UrlMappingAdapter=UrlMappingAdapter}(),!function(){var RESTAdapter=Frzn.UrlMappingAdapter.extend({urlMapping:{find:{url:":resourceURI/:id",dataType:"json",type:"GET"},findAll:{url:":resourceURI/",dataType:"json",type:"GET"},findQuery:{url:":resourceURI/",dataType:"json",type:"GET"},findIds:{url:":resourceURI/?ids=:ids",dataType:"json",type:"GET"},createRecord:{url:":resourceURI/",dataType:"json",type:"POST"},updateRecord:{url:":resourceURI/:id",dataType:"json",type:"PUT"},deleteRecord:{url:":resourceURI/:id",dataType:"json",type:"DELETE"}}});Frzn.RESTAdapter=RESTAdapter}();

/*
 * -------------------------------------------------------
 * Project: Ember Frozen
 * Version: 0.0.1
 *
 * Author:  Pierpaolo Follia
 * Site:     http://madchicken.it
 * Contact: pfollia@gmail.com
 *
 *
 * Copyright (c) 2013 Pierpaolo Follia
 * -------------------------------------------------------
 */

"use strict";!function(){var converters={},Frzn={version:"1.0",attr:function(type,options){return type=type||"string",options=options||{},function(key,value){this._initField(key,options);var converter=Frzn.getConverter(type);if(arguments.length>1){var path="_data."+key;options.isRelationship&&(path="_data."+key+".content");var oldValue=this.get(path);value=converter.convert(value,options),this.set(path,value),oldValue!=value&&this._markDirty(key)}return value=this.get("_data."+key)}.property("_data").meta({type:type,options:options})},hasMany:function(destination,options){return options=options||{},Frzn.registerConverter("hasMany"+destination,ModelArrayConverter.extend({})),Frzn.attr("hasMany"+destination,Ember.merge(options,{isRelationship:!0,relationshipType:"hasMany",destination:destination}))},hasOne:function(destination,options){return options=options||{},Frzn.registerConverter("hasOne"+destination,ModelConverter.extend({})),Frzn.attr("hasOne"+destination,Ember.merge(options,{isRelationship:!0,relationshipType:"hasOne",destination:destination}))},belongsTo:function(destination,options){return options=options||{},Frzn.registerConverter("belongsTo"+destination,ModelConverter.extend({})),Frzn.attr("belongsTo"+destination,Ember.merge(options,{isRelationship:!0,relationshipType:"belongsTo",destination:destination}))},registerConverter:function(name,converter){converters[name]=converter.create()},getConverter:function(name){return converters[name]||SimpleConverter.create({})}},SimpleConverter=Ember.Object.extend({convert:function(value){return value?value.valueOf():value}}),ModelConverter=Ember.Object.extend({convert:function(value,options){return value instanceof options.destination?value:"object"==typeof value?options.destination.create(value):null}}),ModelArrayConverter=Ember.Object.extend({convert:function(value,options){if(value instanceof Array){for(var array=[],i=0;i<value.length;i++)array.push(options.destination.create(value[i]));return array}return null}});Frzn.registerConverter("string",SimpleConverter.extend({convert:function(value){return Ember.isEmpty(value)?value:new String(value).valueOf()}})),Frzn.registerConverter("number",SimpleConverter.extend({convert:function(value){if(null!==value&&void 0!==value){var num=new Number(value);return num.valueOf()}return value}})),Frzn.registerConverter("date",SimpleConverter.extend({convert:function(value){if(null!==value&&void 0!==value){if("string"==typeof value){var d=new Date(Date.parse(value));return isNaN(d.getTime())?null:d}return value instanceof Date?value:null}return value}}));var Relationship=Em.Mixin.create({getObjectClass:function(){return this.get("options.destination")}}),HasManyRelationship=Ember.ArrayProxy.extend(Relationship,{init:function(){this.set("content",Em.A([])),this._super()},create:function(data){var o=this.get("options.destination").create(data);return this.pushObject(o),o}}),HasOneRelationship=Ember.ObjectProxy.extend(Relationship,{}),BelongsToRelationship=Ember.ObjectProxy.extend(Relationship,{init:function(){this._super(),this["get"+this.get("mappedBy")]=function(){return"yo"}}}),relationships={hasOne:HasOneRelationship,hasMany:HasManyRelationship,belongsTo:BelongsToRelationship};Frzn.Model=Ember.Object.extend(Ember.DeferredMixin,Ember.Evented,{isAjax:!1,isLoaded:!1,isSaved:!1,isDeleted:!1,isError:!1,url:null,errors:null,_backup:function(){return this.__backup||(this.__backup={}),this.__backup}.property().cacheable(),_data:function(){return this.__data||(this.__data=Em.Object.create({})),this.__data}.property(),_dirtyAttributes:function(){return this.__dirtyAttributes||(this.__dirtyAttributes=[]),this.__dirtyAttributes}.property(),_properties:function(){return this.__properties||(this.__properties=Em.A([])),this.__properties}.property(),_relationships:function(){return this.__relationships||(this.__relationships=Em.Object.create({})),this.__relationships}.property(),_initField:function(name,options){if(!this.get("_backup")[name]){if(Ember.assert("Field name must not be null",null!==name&&void 0!==name&&""!=name),options=options||{},options.isRelationship){var rel=relationships[options.relationshipType].create({options:options});this.set("_relationships."+name,rel),this.get("_backup")[name]=rel,this.set("_data."+name,rel)}else this.get("_backup")[name]=options.defaultValue,this.set("_data."+name,options.defaultValue);var properties=this.get("_properties");-1===properties.indexOf(name)&&properties.push(name)}},_saveState:function(){for(var properties=this.get("_properties"),backup=this.get("_backup"),i=0;i<properties.length;i++)backup[properties[i]]=this.get("_data."+properties[i]);return this.set("_dirtyAttributes",[]),this},_discardChanges:function(){var backup=this.get("_backup");return this.setProperties(backup),this.set("_data",Ember.Object.create(backup)),this.set("_dirtyAttributes",[]),this},_markDirty:function(field){var dirtyAttributes=this.get("_dirtyAttributes");-1===dirtyAttributes.indexOf(field)&&dirtyAttributes.push(field)},init:function(){this._super(),this._saveState()},discard:function(){return this._discardChanges()},isDirty:function(attr){var dirtyAttributes=this.get("_dirtyAttributes");return void 0!==attr?!Ember.isEmpty(dirtyAttributes)&&-1!=dirtyAttributesindexOf(attr):!Ember.isEmpty(dirtyAttributes)},commit:function(){return this._saveState()},toJSON:function(){return JSON.stringify(this.getProperties(this.get("_properties")))},load:function(data){return this.setProperties(data),this.commit(),this}}),Frzn.Model.reopenClass({getName:function(){var name=this+"";return-1!=name.lastIndexOf(".")&&(name=name.substr(name.lastIndexOf(".")+1)),name.toLowerCase()},find:function(id){return this.adapter.find(this,id)},findAll:function(){},findQuery:function(){}}),window.Frzn=Frzn}(),Frzn.AbstractAdapter=Ember.Object.extend({find:function(){Ember.assert("You must provide a valid find function for your adapter",!1)},findAll:function(){Ember.assert("You must provide a valid findAll function for your adapter",!1)},findQuery:function(){Ember.assert("You must provide a valid findQuery function for your adapter",!1)},createRecord:function(){Ember.assert("You must provide a valid createRecord function for your adapter",!1)},updateRecord:function(){Ember.assert("You must provide a valid updateRecord function for your adapter",!1)},deleteRecord:function(){Ember.assert("You must provide a valid delete function for your adapter",!1)},rootProperty:null,totalProperty:null,pageProperty:null}),Frzn.Fixtures={},Frzn.FixturesAdapter=Frzn.AbstractAdapter.extend({find:function(modelClass,id){var record=modelClass.create(),name=modelClass.getName();return Frzn.Fixtures[name][id]?(record.load(Frzn.Fixtures[name][id]),record.resolve(record)):record.reject({errorCode:404,type:"error",message:"Object not found"}),record},findAll:function(){Ember.assert("You must provide a valid findAll function for your adapter",!1)},findQuery:function(){Ember.assert("You must provide a valid findQuery function for your adapter",!1)},createRecord:function(){Ember.assert("You must provide a valid createRecord function for your adapter",!1)},updateRecord:function(){Ember.assert("You must provide a valid updateRecord function for your adapter",!1)},deleteRecord:function(){Ember.assert("You must provide a valid delete function for your adapter",!1)},rootProperty:null,totalProperty:null,pageProperty:null}),Frzn.QuerySearchResult=Ember.ArrayProxy.extend(Ember.DeferredMixin,{extractMeta:function(data){var meta={};return this.adapter&&(this.adapter.totalProperty&&(meta[this.adapter.rootProperty]=data[this.adapter.rootProperty]),this.adapter.pageProperty&&(meta[this.adapter.pageProperty]=data[this.adapter.pageProperty])),meta}}),Frzn.UrlMappingAdapter=Frzn.AbstractAdapter.extend({urlMapping:{find:{url:":resourceURI/:id",method:"GET"},findAll:{url:":resourceURI/list",method:"GET"},findQuery:{url:":resourceURI/list",method:"GET"},createRecord:{url:":resourceURI/",method:"POST"},updateRecord:{url:":resourceURI/:id",method:"PUT"}},find:function(id){var that=this,model=this.create({});return $.ajax({url:this.urlForAction("show")+"/"+id,dataType:"json",type:"GET",beforeSend:function(){model.set("isAjax",!0)},complete:function(){model.set("isAjax",!1)},statusCode:{200:function(result){console.log("Loaded from server object of type %o: %o",that,result.data),result.data&&(model.setProperties(that.fromJson(result.data)),model.set("_backup",that.create(model)),model.trigger("loaded"),model.resolve(model))},401:function(){model.reject(response,type,title)},404:function(response,type,title){console.log(arguments),model.set("isError",!0),model.trigger("error",response,type,title),model.reject(response,type,title)},500:function(response,type,title){console.log(arguments),model.set("isError",!0),model.trigger("error",response,type,title),model.reject(response,type,title)}}}),model},findAll:function(){data=data||{max:10,offset:0,sort:"lastUpdated",order:"desc"},data=Ember.Object.create(data),console.log("Loading list of %o using parameters %o",this,data);var sr=SR.create({});return $.ajax({url:this.urlForAction("list"),data:data.getJson(),dataType:"json",statusCode:{200:function(result){if(console.log("Loaded list of %o from server: %o",this,result),result.records){var recs=result.records;recs=this.createItemRecords(recs),sr.set("content",recs),sr.set("total",result.total)}sr.resolve(sr)}.bind(this),401:function(){},500:function(response,type,title){sr.reject(response,type,title)}}}),sr},findQuery:function(){data=data||{max:10,offset:0,sort:"lastUpdated",order:"desc"},data=Ember.Object.create(data),console.log("Loading list of %o using parameters %o",this,data);var sr=SR.create({});return $.ajax({url:this.urlForAction("list"),data:data.getJson(),dataType:"json",statusCode:{200:function(result){if(console.log("Loaded list of %o from server: %o",this,result),result.records){var recs=result.records;recs=this.createItemRecords(recs),sr.set("content",recs),sr.set("total",result.total)}sr.resolve(sr)}.bind(this),401:function(){},500:function(response,type,title){sr.reject(response,type,title)}}}),sr},createRecord:function(){Ember.assert("You must provide a valid createRecord function for your adapter",!1)},updateRecord:function(record){record._reset();var json=JSON.stringify(record.getJson()),model=this;return console.log("Saving object %o",json),$.ajax({url:record.constructor.urlForAction("update"),dataType:"json",data:json,contentType:"application/json",type:record.get("id")?"PUT":"POST",beforeSend:function(){model.set("isAjax",!0)},complete:function(){model.set("isAjax",!1)},error:function(response,type,title){var error=JSON.parse(response.responseText).error;model.setProperties(model.get("_backup")),model.set("genericError",[error,type,title]),model.set("messageType","error"),model.reject(model,error,title,type)},statusCode:{200:function(result){model.set("errors",null),model.setProperties(model.constructor.fromJson(result.data)),model.set("isSaved",!0),model.trigger("saved",model),model.resolve(model)},404:function(response,type,title){model.discard(),model.set("genericError",["Not found",type,title]),model.reject(model,"Not found",type,title)},422:function(result,type,title){model.discard();var json=JSON.parse(result.responseText);if(json.errors){var errs=json.errors.errors,errors=errs.reduce(function(previousValue,item){return previousValue[item.field]=item.message,previousValue},{});model.set("errors",errors)}var error=JSON.parse(result.responseText).error;error&&model.set("genericError",[error,type,title]),model.set("messageType","error"),model.reject(model,"Invalid request",type,title)},500:function(response,type,title){model.discard(),model.reject(model,"Internal server error",type,title)}}}),model},deleteRecord:function(){Ember.assert("You must provide a valid delete function for your adapter",!1)}});